### OpenShift Network Triage: capture RX metrics on bonded interfaces

This repository contains a helper script, `capture_bond_metrics.sh`, to triage potential node-level networking issues in OpenShift clusters by collecting RX-related counters from `ethtool -S` on bonded interface slaves across all nodes. By default it focuses on `rx_cache_*` metrics and can include broader RX/GRO/XDP counters with `--extra-metrics`.

### What it does

- **Discovers nodes** using `oc get nodes` (assumes you are logged in and have permissions).
- **Finds bonded interfaces** on each node by inspecting `/proc/net/bonding/*` from within a node debug session.
- **Captures ethtool stats** (`ethtool -S <iface>`) for each bond's slave interface.
- **Extracts `rx_cache_*` metrics** by default; optionally includes additional RX metrics with `--extra-metrics` (e.g., `rx_no_buffer`, `rx_dropped`, `gro_*`, `xdp_*`).
- **Flags potential issues** where any `rx_cache_*` value exceeds a threshold (default: > 0) and highlights bond traffic imbalance.
- **Outputs results** in both a human-readable table and a structured JSON document grouped by node → bond → interface → metric.

### Prerequisites

- `oc` CLI configured and logged into the target OpenShift cluster.
- Permission to run `oc debug node/<node>` (cluster-admin typically required).

### Usage

Run from the repository root:

```bash
./capture_bond_metrics.sh
```

Options:

- **`--threshold N`**: Only flag as an issue when value > N (default 0).
- **`--label SELECTOR`**: Filter nodes by label.
- **`--bond bond0[,bond1]`**: Filter to specific bonds.
- **`--extra-metrics`**: Include additional RX/GRO/XDP metrics.
- **`--table-only`**: Print only the table view.
- **`--json-only`**: Print only the JSON view.

Examples:

```bash
# Default: table + JSON; flag any non-zero counter
./capture_bond_metrics.sh

# Only JSON output, with a higher threshold
./capture_bond_metrics.sh --json-only --threshold 10

# Only the table view
./capture_bond_metrics.sh --table-only
```

### Output

- **Table**: columns for `NODE`, `BOND`, `INTERFACE`, `METRIC`, `VALUE`.
- **JSON**: grouped as `nodes[] → bonds[] → interfaces[] → rx_cache{}` with an `issue` boolean per interface, plus `extra` metrics when `--extra-metrics` is used, and bond-level imbalance fields.

Minimal JSON shape:

```json
{
  "nodes": [
    {
      "name": "node-name",
      "bonds": [
        {
          "name": "bond0",
          "interfaces": [
            {
              "name": "ens1f0",
              "rx_cache": {
                "rx_cache_miss": 0,
                "rx_cache_hit": 0
              },
              "issue": false
            }
          ]
        }
      ]
    }
  ]
}
```

### How it works

- Uses `oc debug node/<node>` and `chroot /host` to read `/proc/net/bonding/*` and run `ethtool -S` on slave interfaces.
- Filters `rx_cache_*` metrics from the ethtool output.
- Applies the threshold to determine the `issue` flag per interface.
- Aggregates and prints both table and JSON views.

### Notes and limitations

- Some drivers/interfaces may not expose `rx_cache_*` counters; those will be skipped silently.
- Running across many nodes can take time due to sequential debug sessions.
- Requires sufficient RBAC to `oc debug` nodes.

### Attribution

This README and the script were generated by Cursor.


